# ============================================================================
# Multi-Market Trading Platform - Docker Compose
# ============================================================================
#
# PURPOSE:
#   Orchestrate multi-market paper trading with complete SCOPE isolation
#
# SERVICES:
#   1. paper-alpaca-swing-us: US market paper trading via Alpaca
#   2. paper-nse-swing-india: India NSE paper trading via simulator
#   3. paper-kraken-crypto-global: Crypto paper trading via Kraken (Phase 0: stub)
#
# CRITICAL DESIGN:
#   - Complete data/logs/models/state isolation between markets
#   - Separate Docker volumes per market (us-data, india-data)
#   - Environment-driven configuration
#   - Shared swing strategies from core (no duplication)
#   - Containers restart automatically unless stopped
#
# USAGE:
#   # Start all markets
#   docker-compose up -d
#
#   # Start only US trading
#   docker-compose up -d paper-alpaca-swing-us
#
#   # Start only India trading
#   docker-compose up -d paper-nse-swing-india
#
#   # View logs
#   docker-compose logs -f paper-alpaca-swing-us
#   docker-compose logs -f paper-nse-swing-india
#
#   # Stop all
#   docker-compose down
#
# ============================================================================

version: '3.8'

services:
  # ==========================================================================
  # US PAPER TRADING (Alpaca)
  # ==========================================================================
  # 
  # SCOPE: paper_alpaca_swing_us
  # Market: US (NYSE/NASDAQ)
  # Broker: Alpaca Paper Trading
  # Strategies: Swing (core/strategies/equity/swing)
  # ==========================================================================
  
  #
  # ==========================================================================
  
  paper-alpaca-swing-us:
    build:
      context: .
      dockerfile: Dockerfile
    
    image: paper-alpaca-swing-us
    container_name: paper-alpaca-swing-us
    
    # Run scheduler with intelligent task timing
    command: python -m execution.scheduler
    
    # Environment variables
    environment:
      # SCOPE configuration
      - ENV=paper
      - BROKER=alpaca
      - MODE=swing
      - MARKET=us
      - PERSISTENCE_ROOT=/app/persist
      
      # US market settings
      - MARKET_TIMEZONE=America/New_York
      - ENTRY_WINDOW_MINUTES_BEFORE_CLOSE=5
      - SWING_EXIT_DELAY_MINUTES_AFTER_CLOSE=15
      
      # Alpaca API credentials (paper trading)
      - ALPACA_API_KEY=${ALPACA_API_KEY}
      - ALPACA_API_SECRET=${ALPACA_API_SECRET}
      - ALPACA_BASE_URL=${ALPACA_BASE_URL:-https://paper-api.alpaca.markets}
      
      # Python settings
      - PYTHONUNBUFFERED=1
    
    # Volume mounts (CRITICAL: Isolated US data)
    volumes:
      - us-data:/app/persist
    
    # Restart policy
    restart: unless-stopped
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  
  # ==========================================================================
  # INDIA PAPER TRADING (NSE Simulator)
  # ==========================================================================
  #
  # SCOPE: paper_nse_simulator_swing_india
  # Market: India (NSE)
  # Broker: NSE Simulator (simulated execution)
  # Strategies: Swing (core/strategies/equity/swing)
  #
  # ==========================================================================
  
  paper-nse-swing-india:
    build:
      context: .
      dockerfile: Dockerfile
    
    image: paper-nse-swing-india
    container_name: paper-nse-swing-india
    
    # Run scheduler with intelligent task timing
    command: python -m execution.scheduler
    
    # Environment variables
    environment:
      # SCOPE configuration
      - ENV=paper
      - BROKER=nse_simulator
      - MODE=swing
      - MARKET=india
      - PERSISTENCE_ROOT=/app/persist
      
      # India market settings
      - MARKET_TIMEZONE=Asia/Kolkata
      - ENTRY_WINDOW_MINUTES_BEFORE_CLOSE=20
      - SWING_EXIT_DELAY_MINUTES_AFTER_CLOSE=15
      
      # Python settings
      - PYTHONUNBUFFERED=1
    
    # Volume mounts (CRITICAL: Isolated India data)
    volumes:
      - india-data:/app/persist
    
    # Restart policy
    restart: unless-stopped
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # CRYPTO PAPER TRADING (Kraken)
  # ==========================================================================
  #
  # SCOPE: paper_kraken_crypto_global
  # Market: Global (24/7 crypto)
  # Broker: Kraken (Phase 1 - currently stub/dry-run)
  # Strategies: 6 canonical crypto strategies (regime-based)
  #
  # ==========================================================================
  
  paper-kraken-crypto-global:
    build:
      context: .
      dockerfile: Dockerfile
    
    image: paper-kraken-crypto-global
    container_name: paper-kraken-crypto-global
    
    # Run crypto scheduler with 24/7 operation
    command: python main.py
    
    # Environment variables
    environment:
      # SCOPE configuration
      - SCOPE=paper_kraken_crypto_global
      - ENV=paper
      - BROKER=kraken
      - MODE=crypto
      - MARKET=global
      - PERSISTENCE_ROOT=/app/persist
      
      # Crypto market settings (24/7 operation)
      - MARKET_TIMEZONE=UTC
      - CASH_ONLY_TRADING=true
      
      # Kraken API credentials (Phase 1 - not functional yet)
      - KRAKEN_API_KEY=${KRAKEN_API_KEY:-stub}
      - KRAKEN_API_SECRET=${KRAKEN_API_SECRET:-stub}
      
      # Python settings
      - PYTHONUNBUFFERED=1
    
    # Volume mounts (CRITICAL: Isolated crypto data)
    volumes:
      - crypto-data:/app/persist
    
    # Restart policy
    restart: unless-stopped
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # GOVERNANCE JOB (Phase C - Weekly Governance)
  # ==========================================================================
  #
  # SCOPE: N/A (reads paper_kraken_crypto_global + live_kraken_crypto_global)
  # Mode: One-time execution (not daemon)
  # Schedule: Weekly (Sunday 3:15 AM ET / 8:15 AM UTC)
  # Purpose: Analyze trading summaries, produce non-binding governance proposals
  #
  # CRITICAL: This runs OUTSIDE trading containers (separate job/container)
  # - Read-only access to daily summaries
  # - Zero ability to modify configs or trade
  # - All proposals are non-binding (require human approval)
  # - Runs once and exits (not a daemon)
  #
  # USAGE:
  #   # Run with persistence (real execution)
  #   docker-compose run --rm governance-crypto python governance_main.py --run-once
  #
  #   # Or via script
  #   ./run_governance_crypto.sh                  # Real run
  #   ./run_governance_crypto.sh --dry-run        # Dry-run (no persistence)
  #
  # SCHEDULING:
  #   # Via cron (on host)
  #   15 8 * * 0 cd /app && ./run_governance_crypto.sh >> /var/log/governance.log 2>&1
  #
  # ==========================================================================

  governance-crypto:
    build:
      context: .
      dockerfile: Dockerfile

    image: governance-crypto
    container_name: governance-crypto-temp

    # Run governance job once and exit
    command: python governance_main.py --run-once

    # Environment variables
    environment:
      # Governance configuration
      - GOVERNANCE_ENABLED=true
      - GOVERNANCE_RUN_ONCE=true
      - GOVERNANCE_LOOKBACK_DAYS=7
      - GOVERNANCE_AI_MODEL=${GOVERNANCE_AI_MODEL:-gpt-4o}
      - GOVERNANCE_AI_TEMPERATURE=0.2

      # Scopes to analyze
      - PAPER_SCOPE=paper.kraken.crypto.global
      - LIVE_SCOPE=live.kraken.crypto.global

      # Persistence
      - PERSISTENCE_ROOT=/app/persist

      # Python settings
      - PYTHONUNBUFFERED=1
      - TZ=UTC

    # Volume mounts (shared crypto persistence)
    volumes:
      - crypto-data:/app/persist

    # CRITICAL: Do NOT restart (one-time job, not daemon)
    restart: "no"

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================================================
# VOLUMES
# ============================================================================
# Named volumes provide complete isolation between markets
# - us-data: All US market data/logs/models/state
# - india-data: All India market data/logs/models/state
# - crypto-data: All crypto market data/logs/models/state
# ============================================================================

volumes:
  us-data:
    driver: local
  india-data:
    driver: local
  crypto-data:
    driver: local

# ============================================================================
# IMPORTANT NOTES
# ============================================================================
#
# 1. MARKET ISOLATION:
#    - US, India, and Crypto data/logs/models/state are COMPLETELY separated
#    - Each market has its own Docker volume (us-data, india-data, crypto-data)
#    - Zero cross-contamination between markets
#
# 2. SCOPE SYSTEM:
#    - US SCOPE: paper_alpaca_swing_us
#    - India SCOPE: paper_nse_simulator_swing_india
#    - Crypto SCOPE: paper_kraken_crypto_global
#    - All data organized by SCOPE in PERSISTENCE_ROOT
#
# 3. SHARED STRATEGIES:
#    - Swing strategies in core/strategies/equity/swing (US & India)
#    - Crypto strategies in core/strategies/crypto (Kraken)
#    - SAME code base, different broker/data adapters
#    - No duplication between markets
#
# 4. SECRETS MANAGEMENT:
#    - Use .env file in same directory as docker-compose.yml
#    - Format:
#        ALPACA_API_KEY=your_key_here
#        ALPACA_API_SECRET=your_secret_here
#        KRAKEN_API_KEY=your_key_here
#        KRAKEN_API_SECRET=your_secret_here
#    - .env file should be in .gitignore
#    - India doesn't need credentials (simulated broker)
#    - Kraken credentials optional for Phase 0 (stub adapter)
#
# 5. RUNNING CONTAINERS:
#    - Start all: docker-compose up -d
#    - Start US only: docker-compose up -d paper-alpaca-swing-us
#    - Start India only: docker-compose up -d paper-nse-swing-india
#    - Start Crypto only: docker-compose up -d paper-kraken-crypto-global
#    - View logs: docker-compose logs -f paper-kraken-crypto-global
#    - Stop all: docker-compose down
#
# 6. REBUILDING:
#    - After code changes: docker-compose build
#    - Or: docker-compose up --build -d
#
# 7. DATA ACCESS:
#    - View US volume data: docker volume inspect trading_app_us-data
#    - View India volume data: docker volume inspect trading_app_india-data
#    - View Crypto volume data: docker volume inspect trading_app_crypto-data
#    - Access container: docker exec -it paper-kraken-crypto-global /bin/bash
#
# 8. PHASE 0 vs PHASE 1:
#    - Phase 0 (CURRENT): Crypto strategies hardened, broker adapter is stub
#    - Phase 1 (IN DEV): Kraken REST API integration for live orders
#    - CASH_ONLY_TRADING=true enforced globally (prevents accidental live orders)
#    - See docs/crypto/kraken/phase0/ for complete architecture details
#
# ============================================================================

