# ============================================================================
# Multi-Market Trading Platform - Docker Compose
# ============================================================================
#
# PURPOSE:
#   Orchestrate multi-market paper trading with complete SCOPE isolation
#
# SERVICES:
#   1. paper-alpaca-swing-us: US market paper trading via Alpaca
#   2. paper-nse-swing-india: India NSE paper trading via simulator
#
# CRITICAL DESIGN:
#   - Complete data/logs/models/state isolation between markets
#   - Separate Docker volumes per market (us-data, india-data)
#   - Environment-driven configuration
#   - Shared swing strategies from core (no duplication)
#   - Containers restart automatically unless stopped
#
# USAGE:
#   # Start all markets
#   docker-compose up -d
#
#   # Start only US trading
#   docker-compose up -d paper-alpaca-swing-us
#
#   # Start only India trading
#   docker-compose up -d paper-nse-swing-india
#
#   # View logs
#   docker-compose logs -f paper-alpaca-swing-us
#   docker-compose logs -f paper-nse-swing-india
#
#   # Stop all
#   docker-compose down
#
# ============================================================================

version: '3.8'

services:
  # ==========================================================================
  # US PAPER TRADING (Alpaca)
  # ==========================================================================
  # 
  # SCOPE: paper_alpaca_swing_us
  # Market: US (NYSE/NASDAQ)
  # Broker: Alpaca Paper Trading
  # Strategies: Swing (core/strategies/equity/swing)
  # ==========================================================================
  
  #
  # ==========================================================================
  
  paper-alpaca-swing-us:
    build:
      context: .
      dockerfile: Dockerfile
    
    container_name: paper-alpaca-swing-us
    
    # Run scheduler with intelligent task timing
    command: python -m execution.scheduler
    
    # Environment variables
    environment:
      # SCOPE configuration
      - ENV=paper
      - BROKER=alpaca
      - MODE=swing
      - MARKET=us
      - BASE_DIR=/app/logs
      
      # US market settings
      - MARKET_TIMEZONE=America/New_York
      - ENTRY_WINDOW_MINUTES_BEFORE_CLOSE=5
      - SWING_EXIT_DELAY_MINUTES_AFTER_CLOSE=15
      
      # Alpaca API credentials (paper trading)
      - ALPACA_API_KEY=${ALPACA_API_KEY}
      - ALPACA_API_SECRET=${ALPACA_API_SECRET}
      - ALPACA_BASE_URL=${ALPACA_BASE_URL:-https://paper-api.alpaca.markets}
      
      # Python settings
      - PYTHONUNBUFFERED=1
    
    # Volume mounts (CRITICAL: Isolated US data)
    volumes:
      - us-data:/app/logs
    
    # Restart policy
    restart: unless-stopped
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  
  # ==========================================================================
  # INDIA PAPER TRADING (NSE Simulator)
  # ==========================================================================
  #
  # SCOPE: paper_nse_simulator_swing_india
  # Market: India (NSE)
  # Broker: NSE Simulator (simulated execution)
  # Strategies: Swing (core/strategies/equity/swing)
  #
  # ==========================================================================
  
  paper-nse-swing-india:
    build:
      context: .
      dockerfile: Dockerfile.india
    
    container_name: paper-nse-swing-india
    
    # Run scheduler with intelligent task timing
    command: python -m execution.scheduler
    
    # Environment variables
    environment:
      # SCOPE configuration
      - ENV=paper
      - BROKER=nse_simulator
      - MODE=swing
      - MARKET=india
      - BASE_DIR=/app/logs
      
      # India market settings
      - MARKET_TIMEZONE=Asia/Kolkata
      - ENTRY_WINDOW_MINUTES_BEFORE_CLOSE=20
      - SWING_EXIT_DELAY_MINUTES_AFTER_CLOSE=15
      
      # Python settings
      - PYTHONUNBUFFERED=1
    
    # Volume mounts (CRITICAL: Isolated India data)
    volumes:
      - india-data:/app/logs
    
    # Restart policy
    restart: unless-stopped
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================================================
# VOLUMES
# ============================================================================
# Named volumes provide complete isolation between markets
# - us-data: All US market data/logs/models/state
# - india-data: All India market data/logs/models/state
# ============================================================================

volumes:
  us-data:
    driver: local
  india-data:
    driver: local

# ============================================================================
# IMPORTANT NOTES
# ============================================================================
#
# 1. MARKET ISOLATION:
#    - US and India data/logs/models/state are COMPLETELY separated
#    - Each market has its own Docker volume (us-data, india-data)
#    - Zero cross-contamination between markets
#
# 2. SCOPE SYSTEM:
#    - US SCOPE: paper_alpaca_swing_us
#    - India SCOPE: paper_nse_simulator_swing_india
#    - All data organized by SCOPE in BASE_DIR
#
# 3. SHARED STRATEGIES:
#    - Swing strategies in core/strategies/equity/swing
#    - SAME code used by both US and India
#    - No duplication, just different broker/data adapters
#
# 4. SECRETS MANAGEMENT:
#    - Use .env file in same directory as docker-compose.yml
#    - Format:
#        ALPACA_API_KEY=your_key_here
#        ALPACA_API_SECRET=your_secret_here
#    - .env file should be in .gitignore
#    - India doesn't need credentials (simulated broker)
#
# 5. RUNNING CONTAINERS:
#    - Start all: docker-compose up -d
#    - Start US only: docker-compose up -d paper-alpaca-swing-us
#    - Start India only: docker-compose up -d paper-nse-swing-india
#    - View logs: docker-compose logs -f paper-nse-swing-india
#    - Stop all: docker-compose down
#
# 6. REBUILDING:
#    - After code changes: docker-compose build
#    - Or: docker-compose up --build -d
#
# 7. DATA ACCESS:
#    - View US volume data: docker volume inspect trading_app_us-data
#    - View India volume data: docker volume inspect trading_app_india-data
#    - Access container: docker exec -it paper-nse-swing-india /bin/bash
#
# ============================================================================

